---
format: fleet
layout: blog
collection: |
  (let [category-reducer (fn [agg item] ; item is a post artifact map
                           (let [category-value (get item :category)]
                             (if category-value
                               (let [canonical-category-value (get item :canonical-category (clojure.string/lower-case (str category-value))),
                                     cat-key (str canonical-category-value)] ; Ensure cat-key is a string
                                 (if (not (clojure.string/blank? cat-key))
                                   (-> agg
                                       (assoc-in [cat-key :id] (str "category/" cat-key))
                                       (assoc-in [cat-key :title] (str "Category: " (clojure.string/capitalize cat-key)))
                                       (update-in [cat-key :count] (fnil inc 0))
                                       (update-in [cat-key :posts] (fnil conj []) item))
                                   agg)) ; If cat-key is blank, return agg unchanged
                               agg)))] ; If no category-value, return agg unchanged
    (->> (:artifacts ctx) ; sequence of artifact maps
         (filter #(and (map? %)
                       (string? (:id %))
                       (re-find #"^posts/" (:id %))
                       (:category %))) ; ensure item is a map, id is a string, is a post, and has a category
         (reduce category-reducer {})
         vals))
---
<main id="categories">
  <h1 class="headline"><(-> ctx :title)></h1>
  <div class="content" id="content">

    <(for [post (->> ctx :posts (sort-by :date-published) reverse)] ">
    <article class="blog-post" itemscope="" itemtype="https://schema.org/BlogPosting">
      <h3 class="headline" itemprop="headline">
          <a class="nunito" href="<(:canonical-link post)>" itemprop="url"><(:title post)></a>
      </h3>

      <div class="subheader">
          <div class="byline">
            <img class="author-icon" src="/img/author_placeholder.svg" />
            <section
              class="author"
              itemprop="author"
              itemscope=""
              itemtype="https://schema.org/Person">
              <span itemprop="name"><(:author post)></span>
              <span itemprop="email" style="visibility: hidden"><(:author-email post)></span>
            </section>
          </div>
          <div class="tags">
            <img class="tag-icon" src="/img/tag_placeholder.svg" />
            <ul itemprop="keywords" class="keywords">
              <(if-let [category (:category post)] ">
              <li class="category">
                <a href="/category/<(-> post :canonical-category)>.html">
                  <(-> category clojure.string/lower-case)>
                </a>
              </li>
              <")>
              <(for [tag (-> post :tags (or []))]
                 (let [tag (clojure.string/lower-case tag)] ">
              <li class="tag">
                <a href="/tags/<(clojure.string/replace tag #"\ " "-")>.html"
                  >#<(str tag)></a
                >
              </li>
              <"))>
            </ul>
          </div>
          <p class="post-meta">
            <time itemprop="datePublished"><(:date-published post)></time> -
            <span itemprop="wordCount"><(:word-count post)></span> words -
            <span itemprop="timeRequired"><(:ttr post)></span> min read
          </p>
      </div>
    </article>
    <")>
  </div>
</main>
